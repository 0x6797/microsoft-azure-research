# Azure Policy に関するよくありそうな質問

## 目次

- [Azure Policy とは何ですか？](#q-about)
- [具体的に、どういったルールが適用できるのでしょうか？](#q-about2)
- [ロールベースのアクセス許可とは違うのでしょうか？](#q-rbac)
- [Azure Policy は Azure リソースに対する状態の確認しか行われないのでしょうか？](#q-roles)
- [ポリシーの割り当ては、組織全体でおこなわれるのか任意の Azure リソースに行われるのか、どちらなんですか？](#q-scope)
- [イニシアチブとは何ですか？いきなりドキュメントに出てきて困惑します。](#q-initiative)
- [Azure Policy での制限はありますか？](#q-limitation)
- [Azure Policy を使用する上でなにか気をつけることはありますか？](#q-practice)
- [カスタムポリシーはどうやって定義するのでしょうか？](#q-custom-policy)

## <a id="q-about">Azure Policy とは何ですか？</a>

Azure リソースに対して、さまざまなルールと効果を適用し、それらが会社の標準のサービスレベルアグリーメントに準拠した状態に保つサービスです。

## <a id="q-about2">具体的に、どういったルールが適用できるのでしょうか？</a>

たとえば、

- 仮想マシン
    - 特定のスペックの仮想マシンのみ許可
    - 任意の仮想マシンがセキュリティ要件を備えているか？
- Azure リソース
    - タグが社内標準のルールに従っているか？所有者、プロジェクトなどの情報を付加しているかなど。
    - 特定のリージョンにのみリソースの作成を許可
    - 期限切れ間近の証明書を使用しているか？

## <a id="q-rbac">ロールベースのアクセス許可とは違うのでしょうか？</a>

違います。RBAC は特定の Azure リソースに対する操作の権限管理で、Azure Policy は Azure リソースに対する状態の管理です。

Azure Policy ではデプロイ中あるいはデプロイ時の状態に関して焦点を充てていますが、RBAC はそうではありません。


## <a id="q-roles">Azure Policy は Azure リソースに対する状態の確認しか行われないのでしょうか？</a>

Azure リソースの状態の監視、修復も行われます。ただし、Azure Policy に適切なロールを割り当てていることが前提です。

たとえば、Azure Policy に「グローバル閲覧者」を割り当てている場合は、すべての Azure リソースに対して、状態の参照を行えますが、修復は書き込み権限がないため行なえません。

## <a id="q-scope">ポリシーの割り当ては、組織全体でおこなわれるのか任意の Azure リソースに行われるのか、どちらなんですか？</a>

ポリシーは特定のスコープに割り当てられます。スコープの範囲は管理グループからリソースグループです。割り当てたポリシーは、すべての子のリソースに継承されます。

## <a id="q-initiative">イニシアチブとは何ですか？いきなりドキュメントに出てきて困惑します。</a>

イニシアチブとは、１つ以上のポリシーのコレクションです。

## <a id="q-limitation">Azure Policy での制限はありますか？</a>

Azure Policy は作成できるオブジェクトに対して最大数があります。

| 範囲 | オブジェクト | 最大数 |
| :------ | :------- | :------ |
| スコープ | ポリシーの定義 | 500 |
| スコープ | イニシアチブの定義 | 100 |
| テナント | イニシアチブの定義 | 1,000 |
| スコープ | ポリシーとイニシアチブの割り当て | 100 |
| ポリシー定義 | パラメーター | 20 |
| イニシアチブ定義 | ポリシー | 100 |
| イニシアチブ定義 | パラメーター | 100 |
| ポリシーとイニシアチブの割り当て | 除外（スコープ外） | 400 |
| ポリシー規則 | 入れ子になった条件 | 512 |


## <a id="q-practice">Azure Policy を使用する上でなにか気をつけることはありますか？</a>

- ポリシーの拒否は最初から導入せず、まず監視で様子を伺い問題ないか精査します
- 定義と割り当てを作成するときは、組織階層を考慮します。管理グループやサブスクリプションレベルの高いレベルで定義を作成し、徐々に次の子レベルまで割り当てを作成します。
- ひとつだけのポリシーを作成する場合でも、イニシアチブ定義に割り当てます。

## <a id="q-custom-policy">カスタムポリシーはどうやって定義するのでしょうか？</a>

JSON フォーマットで、ポリシー定義を記述します。

たとえば、ビルトイン定義の「タグとその値が必要」というポリシーは以下のように定義されています。

```json
{
  "properties": {
    "displayName": "タグとその値が必要",
    "policyType": "BuiltIn",
    "mode": "Indexed",
    "description": "必要なタグとその値を強制的に適用します。リソース グループには適用されません。",
    "metadata": {
      "category": "Tags"
    },
    "parameters": {
      "tagName": {
        "type": "String",
        "metadata": {
          "displayName": "タグ名",
          "description": "タグの名前 (例: environment)"
        }
      },
      "tagValue": {
        "type": "String",
        "metadata": {
          "displayName": "タグ値",
          "description": "タグの値 (例: production)"
        }
      }
    },
    "policyRule": {
      "if": {
        "not": {
          "field": "[concat('tags[', parameters('tagName'), ']')]",
          "equals": "[parameters('tagValue')]"
        }
      },
      "then": {
        "effect": "deny"
      }
    }
  },
  "id": "/providers/Microsoft.Authorization/policyDefinitions/1e30110a-5ceb-460c-a204-c1c3969c6d62",
  "type": "Microsoft.Authorization/policyDefinitions",
  "name": "1e30110a-5ceb-460c-a204-c1c3969c6d62"
}
```