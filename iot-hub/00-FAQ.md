# Azure IoT Hub に関するよくあるかもしれない質問

## 目次

- [Azure IoT Hub とは何ですか？](#q1)
- [IoT Hub を使って何ができますか？](#q12)
- [デバイスの最大登録数は？](#q2)
- [私のデバイスで IoT Hub を利用できますか？](#q10)
- [モジュールとは何ですか？](#q3)
- [デバイスからクラウドへはどの程度のメッセージ送信ができますか？](#q4)
- [デバイスからクラウドへのメッセージサイズの上限は？](#q5)
- [デバイスからクラウドへのメッセージ送信の対応プロトコルは？](#q11)
- [メッセージのフォーマットは？](#q9)
- [メッセージ以外にもデバイスからクラウドへデータを送信する方法は？](#q6)
- [デバイスからのメッセージを IoT Hub 以外のサービスへ送信できますか？](#q7)
- [メッセージの内容によって違うサービスにメッセージを送信できますか？](#q8)
- [サービス開発時にデバイスが用意できません。どうしたらいいですか？](#q13)
- [デバイスのファームウェアを更新できますか？](#q-firmware-update)
- [クラウドからデバイスへメッセージを送信できますか？](#q14)
- [クラウドサービスで提供されていますが、IoT Hub の信頼性は？](#q-sla)
- [IoT Hub に障害が発生したら困るのですが…](#q-ha)
- [IoT Hub に障害によりデータの損失が発生しますか？](#q-rpo)
- [IoT Hub リージョン障害でフェイルオーバーした場合の復旧リージョンはどこですか？](#q-geo-pair)
- [リージョン障害が解消されたので、IoT Hub の実行リージョンを元に戻せますか？](#q-failback)
- [IoT Hub の価格は？](#q-price)
- [IoT Hub を利用中にエディションを変更することは可能ですか？](#q-switch-edition)

## <a id="q1">Azure IoT Hub とはなんですか？</a>

IoT Hub は非常に簡単にいうと以下の機能を提供しています。

- 百万台レベルのデバイス管理
  - デバイスの状態監視
  - ファームウェア更新の管理
  - デバイスのプロビジョニング（IoT Hub Device Provisioning サービスを使用）
- デバイスからクラウドへのメッセージ送信
  - 他サービスへのルーティング
  - セキュリティ
    - データ暗号化
    - デバイスのなりすまし防止など
- クラウドからデバイスへのメッセージ送信
  - デバイスの状態更新
- メッセージのメトリクスの監視

## <a id="q12">IoT Hub を使って何ができますか？</a>

IoT の一般的なシナリオとそれに対応する Azure のアーキテクチャについては、[IoTソリューションアクセラレータ](https://docs.microsoft.com/ja-jp/azure/iot-accelerators/)にショーケースがあります。

## <a id="q2">デバイスの最大登録数は？</a>
デバイスとモジュールを併せて、1,000,000 です。ただし[Microsoft サポート](https://azure.microsoft.com/support/options/)に問い合わせることにより、上限数の引き上げは可能です。

## <a id="q10">私のデバイスで IoT Hub を利用できますか？</a>

Azure IoT Hub が対応するプラットフォームについては、以下のオプションが存在します。

### Microsoft がサポートしている構成

Azure IoT Hub SDK が使用できるプラットフォームであれば利用可能です。Microsoft では次の構成でテストされ、正式にサポートしています。

| OS | TLS ライブラリ | その他の要件 |
| :---- | :--------- | :----------- |
| Linux | OpenSSL、WolfSSL、BearSSL | Berkley ソケット、POSIX |
| iOS 12.2 | OpenSSL または ネイティブ OSX | OSX 1013.4 でエミュレートされる XCode |
| Windows 10 ファミリ<br />(Windows 10 IoT Coreなど) | SChannel | |
| Mbed OS 5.4 | Mbd TLS 2 | [MXChip IoT 開発キット](https://microsoft.github.io/azure-iot-developer-kit/) |
| Azure Sphere OS | WolfSSL | [Azure Sphere MT3620](https://azure.microsoft.com/en-us/services/azure-sphere/get-started/) |
| MacOS High Sierra | | |
| Android API 28 | | Java 8 |

### パートナーがサポートする開発キット

| パートナー | デバイス | リンク | サポート |
| :---------- | :----------- | :------------ | :------------- |
| Espressif | EPS32, EPS8266 | [Esp-azure](https://github.com/espressif/esp-azure) | [GitHub](https://github.com/espressif/esp-azure) |
| Qualcomm | Qualcomm MDM9206 LTE IoT モデム | [Qualcomm LTE for IoT SDK](https://developer.qualcomm.com/software/lte-iot-sdk) | [フォーラム](https://developer.qualcomm.com/forums/software/lte-iot-sdk) |
| ST Microelectoronics | STM32L4, STM32F4 シリーズ | [X-CUBE-AZURE](https://www.st.com/en/embedded-software/x-cube-azure.html) | [サポート](https://www.st.com/content/st_com/en/support/support-home.html) |
| | STM32F7 シリーズ | [P-NUCLEO-AZURE](https://www.st.com/content/st_com/en/products/evaluation-tools/solution-evaluation-tools/communication-and-connectivity-solution-eval-boards/p-nucleo-azure1.html) | |
| | STM32L4 Discovery Kit for IoT ノード | [FP-CLD-AZURE](https://www.st.com/content/st_com/en/products/embedded-software/mcus-embedded-software/stm32-embedded-software/stm32-ode-function-pack-sw/fp-cld-azure1.html) | |
| Texas Instrument | CC3220SF LaunchPad<br />CC3220S LaunchPad<br />CC3235SF LaunchPad<br />CC3235S LaunchPad<br />MSP432E4 LaunchPad | [Azure IoT Plugin for SimpleLink](https://github.com/TexasInstruments/azure-iot-pal-simplelink) | [TI E2E フォーラム](https://e2e.ti.com/)<br />[CC3220 の TIE2E フォーラム](https://e2e.ti.com/support/wireless_connectivity/simplelink_wifi_cc31xx_cc32xx/)<br />[MSP432E3 の TI E2E フォーラム](https://e2e.ti.com/support/microcontrollers/msp430/) |

### SDK を使用せずに IoT Hub に接続する

IoT Hub デバイス SDK を使用できない場合は、HTTPS の要求と応答を送受信できる任意のアプリケーションから、[IoT Hub REST API](https://docs.microsoft.com/en-us/rest/api/iothub/) を使用して IoT Hub に直接接続できます。


## <a id="q3">モジュールとは何ですか？</a>

## <a id="q4">デバイスからクラウドへはどの程度のメッセージ送信ができますか？</a>
エディションによって異なります。

| エディション | スロットル制限 |
| :--------: | :----------------- |
| Free | 1秒あたり 100 送信。または、ユニットごとに 1秒あたり 12 送信 |
| B1 | 1秒あたり 100 送信。または、ユニットごとに 1秒あたり 12 送信 |
| S1 | 1秒あたり 100 送信。または、ユニットごとに 1秒あたり 12 送信 |
| B2 | ユニットごとに 1秒あたり 120 送信 |
| S2 | ユニットごとに 1秒あたり 120 送信 |
| B3 | ユニットごとに 1秒あたり 6,000 送信 |
| S3 | ユニットごとに 1秒あたり 6,000 送信 |

ユニットとはエディションのインスタンスのことです。

たとえば、以下の条件を考えてみましょう。
- S1 を 100 ユニット用意
- 接続デバイスは 1,000

IoT Hub で処理可能なデバイスからの送信は

100 ユニット * 12送信 = 1200 送信/秒 となります。

デバイス同時接続数は 1,000 なので、デバイス 1,000 台すべてが 1秒毎に常にメッセージを送信したとしても、まだ余裕があります（ただし、デバイスが各ユニットに対して均等に接続している場合）。

次に、以下の条件を考えてみましょう
- S3 を　10 ユニット用意
- 接続デバイスは　1,000

10ユニット * 6,000送信 = 60,000 送信/秒

になります。したがって、各デバイスのすべてが170ミリ秒毎にメッセージを送信したとしても、理論値としては IoT Hub はメッセージを処理できる計算になります（ただし、各ユニットが均等にメッセージ処理を行っている場合に限る）。

## <a id="q5">デバイスからクラウドへのメッセージサイズの上限は？</a>

4KB 毎にチャンキングされ、最大メッセージサイズは 256KB です。

## <a id="q11">デバイスからクラウドへのメッセージ送信の対応プロトコルは？</a>

以下のプロトコルをネイティブでサポートしています。

- MQTT v3.1
- AMQP
- HTTPS

Azure IoT プロトコル ゲートウェイをカスタムゲートウェイとすることにより、他のプロトコルにも対応可能です（要開発）。

## <a id="q6">メッセージ以外にもデバイスからクラウドへデータを送信する方法は？</a>

デバイス毎に 10個のファイルを同時にアップロードできます。

## <a id="q9">メッセージのフォーマットは？</a>

IoT Hub のメッセージは以下の内容により構成されています。

- 事前定義された一連のシステムプロパティ
- アプリケーションで定義可能なアプリケーションプロパティ。文字列のディクショナリです
- 非透過的なバイナリ本文

## <a id="q7">デバイスからのメッセージを IoT Hub 以外のサービスへ送信できますか？</a>

メッセージ ルーティング機能を使用して、組み込みイベントハブ互換エンドポイントまたはカスタムエンドポイントにメッセージを送信できます。

カスタムエンドポイントを使用すると以下のサービスへ送信できます。

- BLOB ストレージ
- Service Bus キュー
- Service Bus トピック
- Event Hubs

## <a id="q8">メッセージの内容によって違うサービスにメッセージを送信できますか？</a>

カスタムエンドポイントを作成し、その中でルーティングクエリを設定することにより、エンドポイント毎に送信するメッセージをフィルタすることが可能です。


## <a id="q13">サービス開発時にデバイスが用意できません。どうしたらいいですか？</a>

シミュレートされたデバイスを使用できます。

## <a id="q14">クラウドからデバイスへメッセージを送信できますか？</a>

可能です。

クラウドからデバイスへメッセージを送信するには、次の３つのオプションを検討します。

- ダイレクトメソッド
- デバイスツインの必要なプロパティ
- cloud-to-device メッセージ

それぞれの違いは次のとおりです。

|        | ダイレクトメッソド | デバイスツイン | cloud-to-device |
| :---- | :---------- | :--------------- | :------------ |
| シナリオ | すぐに確認する必要のあるコマンドの送信 | デバイスの状態更新 | デバイス に対する一方的な通知 |
| フロー | 双方向 | 一方向 | 一方向 |
| メッセージの保持 | なし（切断されているデバイスへの通信不可） | 永続的 | 最大48時間 |
| ターゲット | `deviceId` を使用する。<br />ジョブを使用すれば複数デバイスに送信できる | `deviceId` を使用する。<br />ジョブを使用すれば複数デバイスに送信できる | `deviceId` による１台のデバイス |
| メッセージサイズ | 最大ペイロードサイズは 128 KB | プロパティの最大サイズは 8KB | 最大 64KB |
| メッセージ頻度 | 160KB/秒/ユニット以上（エディションによって異なる） | 100/秒以上（エディションによって異なる） | 1.67 送信操作/秒/ユニット以上（エディションによって異なる） |
| プロトコル | MQTT または AMQP | MQTT または AMQP | MQTT、AMQP または HTTPS |

## <a id="q-firmware-update">デバイスのファームウェアを更新できますか？</a>

可能です。

## <a id="q-sla">クラウドサービスで提供されていますが、IoT Hub の信頼性は？</a>

IoT Hub の SLA は 99.99% です。

## <a id="q-ha">IoT Hub に障害が発生したら困るのですが…</a>

IoT Hub は冗長構成されており、リージョン内であれば IoT Hub 利用者が冗長構成を意識することはありません。その場合は、IoT Hub の SLA で保証された信頼性が得られます。

問題は Azure リージョン自体に障害が発生した場合です。IoT Hub はこのような障害が発生した場合に、他のリージョンで IoT Hub をフェイルオーバーさせることにより、システムを回復する手段を提供しています。

フェイルオーバーを行う主体は以下のとおりです。

- Microsoft による自動フェイルオーバー
- サービス利用者による手動フェイルオーバー

上記２つの主な違いは **"目標復旧時間(RTO)"** とサービス利用者による **手動操作の有無** です。それらの違いを表にしたものは次のようになります。

| オプション | 目標復旧時間(RTO) | 手動操作の有無 | 追加コスト |
| :--------- | :------------ | :--------- | :-------- |
| Microsoft による自動フェイルオーバー | 2 〜 26時間 | なし | なし |
| サービス利用者による手動フェイルオーバー | 10 分 〜 2時間 | あり | なし　|

フェイルオーバーに必要な時間は接続するデバイス数にも依存します。たとえば、デバイスが10万台の場合は 15分、デバイスが500万台のときは 1時間以上です。

このような標準のオプション以外にも、サービス利用者がリージョン間の高可用性を担保する設計／実装することもできます。たとえば、IoT Hub のリージョン間での HA クラスタ運用や、IoT Edge によるエッジ環境でのデータキャッシング等です。

## <a id="q-rpo">IoT Hub に障害によりデータの損失が発生しますか？</a>

データの損失が発生する可能性はあります。標準のフェイルオーバーのオプションに対して損失する可能性のあるデータとその範囲については、次のように **"回復ポイントの目標(RPO)** が設定されています。

| データ型 | 回復ポイントの目標(RPO) |
| :---------- | :------------------ |
| ID レジストリ | 0 〜 5 分間のデータ損失 |
| デバイスツインデータ | 0 〜　5 分間のデータ損失 |
| cloud-to-device メッセージ | 0 〜 5 分間の損失 |
| 親とデバイスのジョブ | 0 〜 5分間の損失 |
| device-to-cloud メッセージ | すべての未読メッセージが損失 |
| 操作の監視メッセージ | すべての未読メッセージが損失 |
| クラウドからデバイスへのフィードバックメッセージ | すべての未読メッセージが損失 |

ただし、cloud-to-device メッセージと親ジョブは、手動フェイルオーバーの一部として回復されません。


## <a id="q-geo-pair">IoT Hub リージョン障害でフェイルオーバーした場合の復旧リージョンはどこですか？</a>

Azure geo ペアリーションになります。たとえば、東日本で障害が発生した場合の復旧リージョンは西日本になります。


## <a id="q-failback">リージョン障害が解消されたので、IoT Hub の実行リージョンを元に戻せますか？</a>

フェイルバックを実行することによって、IoT Hub の実行リージョンを元に戻すことができます。ただし、フェイルオーバーを完了した一時間以内にフェイルバックを実行することはできません。

## <a id="q-price">IoT Hub の価格は？</a>

エディションによって異なります。エディションのユニットあたりの価格は次のようになります。

| エディション | 月あたりの価格 | 一日あたりのメッセージ処理量（概算） |
| :----: | ----: | ----------: |
| F1 Free | 無料 | 8,000 |
| B1 Basic | 1,116 JPY | 400,000 |
| B2 Basic | 5,611 JPY | 6,000,000 |
| B3 Basic | 55,986 JPY | 300,000,000 |
| S1 Standard | 2,759 JPY | 400,000 |
| S2 Standard | 28,024 JPY | 6,000,000 |
| S3 Standard | 280,085 JPY | 300,000,000 |


## <a id="q-switch-edition">IoT Hub を利用中にエディションを変更することは可能ですか？</a>

- アップグレードすることは常に可能です。ただし、下位グレードにダウングレードすることはできません。
- スケールアップおよびスケールダウンについては常に可能です。

たとえば、

- Basic を使用していて、Standard にアップグレードすることは可能です。Standard から Basic にダウングレードすることはできません。
- B1 から B3 にスケールアップ、あるいは B3 から B1 にスケールダウンすることは可能です。
- S1 から S2 にスケールアップ、あるいは S3 から S1 にスケールダウンすることは可能です。


ただし、Free エディションから他のエディションへの変更はできません。
